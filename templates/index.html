
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BELWEST - Дашборд посетителей</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <span>BELWEST</span>
            </div>
            <ul class="menu">
                <li class="active">
                    <a href="/">
                        <i class="fas fa-chart-line"></i>
                        <span>Дашборд</span>
                    </a>
                </li>
                <li>
                    <a href="/users">
                        <i class="fas fa-users"></i>
                        <span>Пользователи</span>
                    </a>
                </li>
                <li>
                    <a href="/sensors">
                        <i class="fas fa-robot"></i>
                        <span>Датчики</span>
                    </a>
                </li>
                <li>
                    <a href="/reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Отчеты</span>
                    </a>
                </li>
                <li>
                    <a href="/settings">
                        <i class="fas fa-cog"></i>
                        <span>Настройки</span>
                    </a>
                </li>
            </ul>
            <div class="sidebar-settings">
                <div class="settings-dropdown">
                    <button class="settings-btn" id="settings-btn">
                        <i class="fas fa-cog"></i>
                        <span>Настройки</span>
                        <i class="fas fa-chevron-down settings-arrow"></i>
                    </button>
                    <div class="settings-menu">
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-moon"></i>
                                <span>Темная тема</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle" data-setting="darkMode">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-bell"></i>
                                <span>Уведомления</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="notifications-toggle" data-setting="notifications" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-chart-line"></i>
                                <span>Авто-обновление</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="auto-update-toggle" data-setting="autoUpdate" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="main-content">
            <!-- Верхняя панель -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>Дашборд посетителей</h1>
                </div>
                <div class="top-bar-center">
                    <div class="analytics-controls">
                        <select id="location-filter" class="modern-select">
                            <option value="all">Все локации</option>
                            <option value="store">Магазин</option>
                            <option value="tu">ТУ</option>
                            <option value="rd">РД</option>
                        </select>
                        <select id="period-select" class="modern-select">
                            <option value="hour">Час</option>
                            <option value="day">День</option>
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="year">Год</option>
                        </select>
                        <button id="refresh-data" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="user-profile">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Поиск по дашборду...">
                        </div>
                        <div class="notifications" id="notifications-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count">3</span>
                            <div class="notification-dropdown" id="notification-dropdown">
                                <div class="notification-header">
                                    <h4>Уведомления</h4>
                                    <button class="mark-all-read">Прочитать все</button>
                                </div>
                                <div class="notification-list">
                                    <div class="notification-item unread">
                                        <div class="notification-icon">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        </div>
                                        <div class="notification-content">
                                            <div class="notification-title">Датчик офлайн</div>
                                            <div class="notification-text">Датчик "Вход основной" не отвечает</div>
                                            <div class="notification-time">5 минут назад</div>
                                        </div>
                                    </div>
                                    <div class="notification-item unread">
                                        <div class="notification-icon">
                                            <i class="fas fa-users text-success"></i>
                                        </div>
                                        <div class="notification-content">
                                            <div class="notification-title">Пиковая нагрузка</div>
                                            <div class="notification-text">Превышен порог посетителей (200+)</div>
                                            <div class="notification-time">15 минут назад</div>
                                        </div>
                                    </div>
                                    <div class="notification-item">
                                        <div class="notification-icon">
                                            <i class="fas fa-check-circle text-success"></i>
                                        </div>
                                        <div class="notification-content">
                                            <div class="notification-title">Система обновлена</div>
                                            <div class="notification-text">Версия 2.1.4 успешно установлена</div>
                                            <div class="notification-time">1 час назад</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="user-info" id="user-menu-btn">
                            <i class="fas fa-user-circle" style="font-size: 40px; color: var(--belwest-green);"></i>
                            <span>Админ</span>
                            <div class="user-dropdown" id="user-dropdown">
                                <div class="user-dropdown-header">
                                    <div class="user-avatar">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    <div class="user-details">
                                        <div class="user-name">Администратор</div>
                                        <div class="user-role">Полный доступ</div>
                                    </div>
                                </div>
                                <div class="user-dropdown-menu">
                                    <a href="/profile" class="dropdown-item">
                                        <i class="fas fa-user"></i>
                                        <span>Профиль</span>
                                    </a>
                                    <a href="/settings" class="dropdown-item">
                                        <i class="fas fa-cog"></i>
                                        <span>Настройки</span>
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="#" class="dropdown-item" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Выйти</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основные метрики -->
            <div class="metrics-grid">
                <div class="metric-card visitors-today">
                    <div class="metric-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="today-visitors">1,247</div>
                        <div class="metric-label">Посетители сегодня</div>
                        <div class="metric-change positive" id="visitors-change">+12.5%</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="visitors-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card active-sensors">
                    <div class="metric-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="active-sensors">98</div>
                        <div class="metric-label">Активных датчиков</div>
                        <div class="metric-change positive" id="sensors-change">+2</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="sensors-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card peak-time">
                    <div class="metric-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="peak-time">14:30</div>
                        <div class="metric-label">Пиковое время</div>
                        <div class="metric-change neutral" id="peak-change">Будни</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="peak-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card hourly-avg">
                    <div class="metric-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="hourly-avg">52</div>
                        <div class="metric-label">Средний поток в час</div>
                        <div class="metric-change positive" id="avg-change">+8.3%</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="avg-mini-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Основные графики -->
            <div class="charts-container">
                <div class="chart-card main-chart">
                    <div class="chart-header">
                        <h3>Динамика посетителей</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-chart="visitors">Посетители</button>
                            <button class="chart-btn" data-chart="comparison">Сравнение</button>
                            <button class="chart-btn" data-chart="trend">Тренд</button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="main-visitors-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card stores-chart">
                    <div class="chart-header">
                        <h3>Статистика по локациям</h3>
                        <div class="chart-legend" id="stores-legend"></div>
                    </div>
                    <div class="chart-content">
                        <canvas id="stores-distribution-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Детальная информация -->
            <div class="details-container">
                <div class="detail-card sensors-status">
                    <div class="detail-header">
                        <h3>Состояние датчиков</h3>
                        <div class="detail-controls">
                            <button class="detail-btn" id="sensors-grid-btn">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="detail-btn active" id="sensors-list-btn">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="detail-btn" id="sensors-map-btn">
                                <i class="fas fa-map"></i>
                            </button>
                        </div>
                    </div>
                    <div class="detail-content">
                        <div class="sensors-view" id="sensors-grid-view">
                            <div class="sensors-grid" id="sensors-grid"></div>
                        </div>
                        <div class="sensors-view active" id="sensors-list-view">
                            <div class="sensors-list" id="sensors-list"></div>
                        </div>
                        <div class="sensors-view" id="sensors-map-view">
                            <div class="sensors-map">
                                <div class="map-placeholder">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <p>Интерактивная карта датчиков</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-card activity-feed">
                    <div class="detail-header">
                        <h3>Активность в реальном времени</h3>
                        <div class="activity-controls">
                            <button class="activity-filter active" data-filter="all">Все</button>
                            <button class="activity-filter" data-filter="visitors">Посетители</button>
                            <button class="activity-filter" data-filter="sensors">Датчики</button>
                            <button class="activity-filter" data-filter="alerts">Алерты</button>
                        </div>
                    </div>
                    <div class="detail-content">
                        <div class="activity-stream" id="activity-stream"></div>
                    </div>
                </div>
            </div>

            <!-- Отключенные датчики -->
            <div class="downtime-section">
                <div class="downtime-card">
                    <div class="downtime-header">
                        <h3>Отключения датчиков</h3>
                        <div class="downtime-controls">
                            <select id="downtime-filter" class="modern-select">
                                <option value="all">Все локации</option>
                                <option value="store">Магазины</option>
                                <option value="tu">ТУ</option>
                                <option value="rd">РД</option>
                            </select>
                            <select id="downtime-period" class="modern-select">
                                <option value="today">Сегодня</option>
                                <option value="week">Неделя</option>
                                <option value="month">Месяц</option>
                            </select>
                        </div>
                    </div>
                    <div class="downtime-content">
                        <div class="downtime-stats">
                            <div class="downtime-stat">
                                <div class="stat-value">12</div>
                                <div class="stat-label">Отключений</div>
                            </div>
                            <div class="downtime-stat">
                                <div class="stat-value">2.3ч</div>
                                <div class="stat-label">Среднее время</div>
                            </div>
                            <div class="downtime-stat">
                                <div class="stat-value">98.7%</div>
                                <div class="stat-label">Время работы</div>
                            </div>
                        </div>
                        <div class="downtime-list" id="downtime-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/page-transitions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visitor-dashboard.js') }}"></script>
    <script>
        // Инициализация дашборда
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            loadDashboardData();
        });

        function initializeDashboard() {
            // Инициализация уведомлений
            const notificationsBell = document.querySelector('.notifications');
            const userInfo = document.querySelector('.user-info');

            if (notificationsBell) {
                notificationsBell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    if (userInfo) userInfo.classList.remove('active');
                });
            }

            if (userInfo) {
                userInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    if (notificationsBell) notificationsBell.classList.remove('active');
                });
            }

            // Закрытие выпадающих меню
            document.addEventListener('click', function() {
                if (notificationsBell) notificationsBell.classList.remove('active');
                if (userInfo) userInfo.classList.remove('active');
            });

            // Инициализация настроек
            const settingsBtn = document.getElementById('settings-btn');
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsBtn && settingsDropdown) {
                settingsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('active');
                });
            }

            // Обработка переключателей
            const toggles = document.querySelectorAll('.toggle-switch input');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const setting = this.dataset.setting;
                    const isEnabled = this.checked;
                    
                    // Сохранение настроек
                    localStorage.setItem(setting, isEnabled);
                    
                    // Применение настроек
                    if (setting === 'darkMode') {
                        document.body.classList.toggle('dark-mode', isEnabled);
                    }
                });
                
                // Загрузка сохраненных настроек
                const setting = toggle.dataset.setting;
                const savedValue = localStorage.getItem(setting);
                if (savedValue !== null) {
                    toggle.checked = savedValue === 'true';
                    if (setting === 'darkMode' && toggle.checked) {
                        document.body.classList.add('dark-mode');
                    }
                }
            });
        }

        function setupEventListeners() {
            // Фильтры и управление
            const locationFilter = document.getElementById('location-filter');
            const periodSelect = document.getElementById('period-select');
            const refreshBtn = document.getElementById('refresh-data');

            if (locationFilter) {
                locationFilter.addEventListener('change', function() {
                    loadDashboardData();
                });
            }

            if (periodSelect) {
                periodSelect.addEventListener('change', function() {
                    loadDashboardData();
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.classList.add('rotating');
                    loadDashboardData();
                    setTimeout(() => this.classList.remove('rotating'), 1000);
                });
            }

            // Переключение видов датчиков
            const sensorsGridBtn = document.getElementById('sensors-grid-btn');
            const sensorsListBtn = document.getElementById('sensors-list-btn');
            const sensorsMapBtn = document.getElementById('sensors-map-btn');

            if (sensorsGridBtn) {
                sensorsGridBtn.addEventListener('click', function() {
                    switchSensorsView('grid');
                });
            }

            if (sensorsListBtn) {
                sensorsListBtn.addEventListener('click', function() {
                    switchSensorsView('list');
                });
            }

            if (sensorsMapBtn) {
                sensorsMapBtn.addEventListener('click', function() {
                    switchSensorsView('map');
                });
            }

            // Фильтры активности
            const activityFilters = document.querySelectorAll('.activity-filter');
            activityFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    activityFilters.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    filterActivityStream(this.dataset.filter);
                });
            });

            // Контролы графиков
            const chartBtns = document.querySelectorAll('.chart-btn');
            chartBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    chartBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    switchMainChart(this.dataset.chart);
                });
            });
        }

        function switchSensorsView(view) {
            const buttons = document.querySelectorAll('.detail-btn');
            const views = document.querySelectorAll('.sensors-view');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            views.forEach(view => view.classList.remove('active'));
            
            document.getElementById(`sensors-${view}-btn`).classList.add('active');
            document.getElementById(`sensors-${view}-view`).classList.add('active');
        }

        function filterActivityStream(filter) {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => {
                if (filter === 'all' || item.dataset.type === filter) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function switchMainChart(chartType) {
            // Логика переключения главного графика
            console.log('Switching to chart:', chartType);
            // Здесь будет код для переключения между разными типами графиков
        }

        // Автообновление данных
        setInterval(function() {
            const autoUpdate = document.getElementById('auto-update-toggle');
            if (autoUpdate && autoUpdate.checked) {
                loadDashboardData();
            }
        }, 30000); // Каждые 30 секунд
    </script>
</body>
</html>
