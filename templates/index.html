
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BELWEST - Дашборд посетителей</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_API_KEY&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <div class="container">
        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <span>BELWEST</span>
            </div>
            <ul class="menu">
                <li class="active">
                    <a href="/">
                        <i class="fas fa-chart-line"></i>
                        <span>Дашборд</span>
                    </a>
                </li>
                <li>
                    <a href="/users">
                        <i class="fas fa-users"></i>
                        <span>Пользователи</span>
                    </a>
                </li>
                <li>
                    <a href="/sensors">
                        <i class="fas fa-robot"></i>
                        <span>Датчики</span>
                    </a>
                </li>
                <li>
                    <a href="/reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Отчеты</span>
                    </a>
                </li>
                <li>
                    <a href="/settings">
                        <i class="fas fa-cog"></i>
                        <span>Настройки</span>
                    </a>
                </li>
            </ul>
            <div class="sidebar-settings">
                <div class="settings-dropdown">
                    <button class="settings-btn" id="settings-btn">
                        <i class="fas fa-cog"></i>
                        <span>Настройки</span>
                        <i class="fas fa-chevron-down settings-arrow"></i>
                    </button>
                    <div class="settings-menu">
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-moon"></i>
                                <span>Темная тема</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle" data-setting="darkMode">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-bell"></i>
                                <span>Уведомления</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="notifications-toggle" data-setting="notifications" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-chart-line"></i>
                                <span>Авто-обновление</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="auto-update-toggle" data-setting="autoUpdate" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-globe"></i>
                                <span>Язык</span>
                            </div>
                            <select id="language-select" class="modern-select" style="margin-left: auto;">
                                <option value="ru">Русский</option>
                                <option value="en">English</option>
                                <option value="be">Беларуская</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-volume-up"></i>
                                <span>Звуки</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="sound-toggle" data-setting="sounds">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <i class="fas fa-save"></i>
                                <span>Авто-сохранение</span>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="autosave-toggle" data-setting="autosave" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="main-content">
            <!-- Верхняя панель -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>Дашборд посетителей</h1>
                </div>
                <div class="top-bar-center">
                    <div class="analytics-controls">
                        <select id="hierarchy-type" class="modern-select">
                            <option value="all">Все данные</option>
                            <option value="manager">По менеджеру</option>
                            <option value="rd">По РД</option>
                            <option value="tu">По ТУ</option>
                            <option value="store">По магазину</option>
                        </select>
                        <select id="entity-selector" class="modern-select" style="display: none;">
                            <option value="">Выберите...</option>
                        </select>
                        <select id="period-select" class="modern-select">
                            <option value="hour">Час</option>
                            <option value="day">День</option>
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="year">Год</option>
                        </select>
                        <button id="refresh-data" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="user-profile">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="dashboard-search" placeholder="Поиск по дашборду...">
                        </div>
                        
                        <div class="user-info" id="user-menu-btn">
                            <i class="fas fa-user-circle" style="font-size: 40px; color: var(--belwest-green);"></i>
                            <span>Админ</span>
                            <div class="user-dropdown" id="user-dropdown">
                                <div class="user-dropdown-header">
                                    <div class="user-avatar">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    <div class="user-details">
                                        <div class="user-name">Администратор</div>
                                        <div class="user-role">Полный доступ</div>
                                    </div>
                                </div>
                                <div class="user-dropdown-menu">
                                    <a href="/profile" class="dropdown-item">
                                        <i class="fas fa-user"></i>
                                        <span>Профиль</span>
                                    </a>
                                    <a href="/settings" class="dropdown-item">
                                        <i class="fas fa-cog"></i>
                                        <span>Настройки</span>
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Выйти из системы</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основные метрики -->
            <div class="metrics-grid">
                <div class="metric-card visitors-today">
                    <div class="metric-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Все посетители</div>
                        <div class="metric-value" id="today-visitors">141</div>
                        <div class="metric-subtitle">За сегодня</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="visitors-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card active-sensors">
                    <div class="metric-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Активные датчики</div>
                        <div class="metric-value" id="active-sensors">98</div>
                        <div class="metric-subtitle">Из 100</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="sensors-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card peak-time">
                    <div class="metric-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Пиковое время</div>
                        <div class="metric-value" id="peak-time">05:00</div>
                        <div class="metric-subtitle">Сегодня</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="peak-mini-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card hourly-avg">
                    <div class="metric-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Посетители в минуту</div>
                        <div class="metric-value" id="hourly-avg">0</div>
                        <div class="metric-subtitle">Сейчас</div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="avg-mini-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Основной график динамики -->
            <div class="main-chart-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Динамика посетителей</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-period="today">Сегодня</button>
                            <button class="chart-btn" data-period="week">Неделя</button>
                            <button class="chart-btn" data-period="month">Месяц</button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="main-visitors-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Нижняя секция -->
            <div class="bottom-section">
                <!-- Состояние датчиков -->
                <div class="detail-card sensors-status">
                    <div class="detail-header">
                        <h3>Состояние датчиков</h3>
                        <div class="detail-controls">
                            <button class="detail-btn active" id="sensors-list-btn">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="detail-btn" id="sensors-grid-btn">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="detail-btn" id="sensors-map-btn">
                                <i class="fas fa-map"></i>
                            </button>
                        </div>
                    </div>
                    <div class="detail-content">
                        <div class="sensors-view active" id="sensors-list-view">
                            <div class="sensors-list" id="sensors-list"></div>
                        </div>
                        <div class="sensors-view" id="sensors-grid-view">
                            <div class="sensors-grid" id="sensors-grid"></div>
                        </div>
                        <div class="sensors-view" id="sensors-map-view">
                            <div class="sensors-map" id="sensors-map">
                                <div id="yandex-map" style="width: 100%; height: 400px; border-radius: 12px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Активность в реальном времени -->
                <div class="detail-card activity-feed">
                    <div class="detail-header">
                        <h3>Активность в реальном времени</h3>
                        <div class="activity-controls">
                            <button class="activity-filter active" data-filter="all">Все</button>
                            <button class="activity-filter" data-filter="visitors">Посетители</button>
                            <button class="activity-filter" data-filter="sensors">Датчики</button>
                            <button class="activity-filter" data-filter="alerts">Алерты</button>
                        </div>
                    </div>
                    <div class="detail-content">
                        <div class="activity-stream" id="activity-stream"></div>
                    </div>
                </div>
            </div>

            <!-- Отключенные датчики -->
            <div class="sensor-downtime-section">
                <div class="downtime-card">
                    <div class="downtime-header">
                        <h3>Отключенные датчики</h3>
                        <div class="downtime-controls">
                            <select id="downtime-period" class="modern-select">
                                <option value="today">Сегодня</option>
                                <option value="week">Неделя</option>
                                <option value="month">Месяц</option>
                            </select>
                            <select id="downtime-filter" class="modern-select">
                                <option value="all">Все статусы</option>
                                <option value="offline">Офлайн</option>
                                <option value="error">Ошибки</option>
                            </select>
                        </div>
                    </div>
                    <div class="downtime-content">
                        <div class="downtime-list" id="downtime-list"></div>
                    </div>
                </div>
            </div>

            <!-- Отключенные датчики -->
            <div class="downtime-section">
                <div class="downtime-card">
                    <div class="downtime-header">
                        <h3>Отключения датчиков</h3>
                        <div class="downtime-controls">
                            <select id="downtime-filter" class="modern-select">
                                <option value="all">Все локации</option>
                                <option value="store">Магазины</option>
                                <option value="tu">ТУ</option>
                                <option value="rd">РД</option>
                            </select>
                            <select id="downtime-period" class="modern-select">
                                <option value="today">Сегодня</option>
                                <option value="week">Неделя</option>
                                <option value="month">Месяц</option>
                            </select>
                        </div>
                    </div>
                    <div class="downtime-content">
                        <div class="downtime-stats">
                            <div class="downtime-stat">
                                <div class="stat-value">12</div>
                                <div class="stat-label">Отключений</div>
                            </div>
                            <div class="downtime-stat">
                                <div class="stat-value">2.3ч</div>
                                <div class="stat-label">Среднее время</div>
                            </div>
                            <div class="downtime-stat">
                                <div class="stat-value">98.7%</div>
                                <div class="stat-label">Время работы</div>
                            </div>
                        </div>
                        <div class="downtime-list" id="downtime-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/page-transitions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visitor-dashboard.js') }}"></script>
    <script>
        // Инициализация дашборда
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            setupDowntimeFilters();
            loadDashboardData();
            loadDowntimeData();
        });

        function initializeDashboard() {
            // Инициализация уведомлений
            const notificationsBell = document.querySelector('.notifications');
            const userInfo = document.querySelector('#user-menu-btn');

            if (notificationsBell) {
                notificationsBell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    if (userInfo) userInfo.classList.remove('active');
                });
            }

            if (userInfo) {
                userInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('User menu clicked');
                    this.classList.toggle('active');
                    if (notificationsBell) notificationsBell.classList.remove('active');
                });
            }

            // Закрытие выпадающих меню
            document.addEventListener('click', function() {
                if (notificationsBell) notificationsBell.classList.remove('active');
                if (userInfo) userInfo.classList.remove('active');
            });

            // Инициализация поиска
            initializeDashboardSearch();

            // Инициализация настроек
            const settingsBtn = document.getElementById('settings-btn');
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsBtn && settingsDropdown) {
                settingsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('active');
                });
            }

            // Обработка переключателей
            const toggles = document.querySelectorAll('.toggle-switch input');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const setting = this.dataset.setting;
                    const isEnabled = this.checked;
                    
                    // Сохранение настроек
                    localStorage.setItem(setting, isEnabled);
                    
                    // Применение настроек
                    if (setting === 'darkMode') {
                        document.body.classList.toggle('dark-mode', isEnabled);
                    }
                });
                
                // Загрузка сохраненных настроек
                const setting = toggle.dataset.setting;
                const savedValue = localStorage.getItem(setting);
                if (savedValue !== null) {
                    toggle.checked = savedValue === 'true';
                    if (setting === 'darkMode' && toggle.checked) {
                        document.body.classList.add('dark-mode');
                    }
                }
            });
        }

        function setupEventListeners() {
            // Фильтры и управление
            const locationFilter = document.getElementById('location-filter');
            const periodSelect = document.getElementById('period-select');
            const refreshBtn = document.getElementById('refresh-data');

            // Обработка иерархических фильтров
            const hierarchyType = document.getElementById('hierarchy-type');
            const entitySelector = document.getElementById('entity-selector');
            
            if (hierarchyType) {
                hierarchyType.addEventListener('change', function() {
                    const selectedType = this.value;
                    if (selectedType === 'all') {
                        entitySelector.style.display = 'none';
                        loadDashboardData();
                    } else {
                        entitySelector.style.display = 'block';
                        loadEntityOptions(selectedType);
                    }
                });
            }
            
            if (entitySelector) {
                entitySelector.addEventListener('change', function() {
                    if (this.value) {
                        loadDashboardData();
                    }
                });
            }

            if (periodSelect) {
                periodSelect.addEventListener('change', function() {
                    loadDashboardData();
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.classList.add('rotating');
                    loadDashboardData();
                    setTimeout(() => this.classList.remove('rotating'), 1000);
                });
            }

            // Переключение видов датчиков
            const sensorsGridBtn = document.getElementById('sensors-grid-btn');
            const sensorsListBtn = document.getElementById('sensors-list-btn');
            const sensorsMapBtn = document.getElementById('sensors-map-btn');

            if (sensorsGridBtn) {
                sensorsGridBtn.addEventListener('click', function() {
                    switchSensorsView('grid');
                });
            }

            if (sensorsListBtn) {
                sensorsListBtn.addEventListener('click', function() {
                    switchSensorsView('list');
                });
            }

            if (sensorsMapBtn) {
                sensorsMapBtn.addEventListener('click', function() {
                    switchSensorsView('map');
                });
            }

            // Фильтры активности
            const activityFilters = document.querySelectorAll('.activity-filter');
            activityFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    activityFilters.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    filterActivityStream(this.dataset.filter);
                });
            });

            // Контролы графиков
            const chartBtns = document.querySelectorAll('.chart-btn');
            chartBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    chartBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    switchMainChart(this.dataset.chart);
                });
            });
        }

        function switchSensorsView(view) {
            const buttons = document.querySelectorAll('.detail-btn');
            const views = document.querySelectorAll('.sensors-view');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            views.forEach(view => view.classList.remove('active'));
            
            document.getElementById(`sensors-${view}-btn`).classList.add('active');
            document.getElementById(`sensors-${view}-view`).classList.add('active');
        }

        function filterActivityStream(filter) {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => {
                if (filter === 'all' || item.dataset.type === filter) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function switchMainChart(chartType) {
            // Логика переключения главного графика
            console.log('Switching to chart:', chartType);
            // Здесь будет код для переключения между разными типами графиков
        }

        // Автообновление данных
        setInterval(function() {
            const autoUpdate = document.getElementById('auto-update-toggle');
            if (autoUpdate && autoUpdate.checked) {
                loadDashboardData();
                loadNotifications();
            }
        }, 30000); // Каждые 30 секунд

        // Функция поиска по дашборду
        function initializeDashboardSearch() {
            const searchInput = document.getElementById('dashboard-search');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase().trim();
                    performDashboardSearch(query);
                });
            }
        }

        function performDashboardSearch(query) {
            // Поиск по метрикам
            const metricCards = document.querySelectorAll('.metric-card');
            metricCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                } else {
                    card.style.display = 'none';
                }
            });

            // Поиск по элементам активности
            const activityItems = document.querySelectorAll('.activity-item');
            activityItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Поиск по датчикам
            const sensorItems = document.querySelectorAll('.sensor-item');
            sensorItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Поиск по графикам
            const chartCards = document.querySelectorAll('.chart-card');
            chartCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Функция загрузки опций для выбранного типа иерархии
        function loadEntityOptions(type) {
            fetch(`/api/hierarchy/${type}`)
                .then(response => response.json())
                .then(data => {
                    const entitySelector = document.getElementById('entity-selector');
                    entitySelector.innerHTML = '<option value="">Выберите...</option>';
                    
                    data.forEach(entity => {
                        const option = document.createElement('option');
                        option.value = entity.id;
                        option.textContent = entity.name;
                        entitySelector.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка загрузки опций:', error);
                });
        }

        // Функция загрузки уведомлений
        function loadNotifications() {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    updateNotificationsList(data.notifications);
                    updateNotificationBadge(data.unread_count);
                })
                .catch(error => {
                    console.error('Ошибка загрузки уведомлений:', error);
                });
        }

        function updateNotificationsList(notifications) {
            const notificationList = document.getElementById('notification-list');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>Нет новых уведомлений</p>
                    </div>
                `;
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.is_read ? '' : 'unread'}" data-id="${notification.id}">
                    <div class="notification-icon">
                        <i class="fas ${getNotificationIcon(notification.type)} ${getNotificationColor(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-text">${notification.message}</div>
                        <div class="notification-time">${formatTime(notification.created_at)}</div>
                    </div>
                </div>
            `).join('');

            // Добавляем обработчики клика для уведомлений
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const notificationId = this.dataset.id;
                    markNotificationAsRead(notificationId);
                    this.classList.remove('unread');
                });
            });
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-count');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'sensor_offline': 'fa-exclamation-triangle',
                'sensor_online': 'fa-check-circle',
                'high_traffic': 'fa-users',
                'low_traffic': 'fa-user-minus',
                'system_update': 'fa-sync-alt',
                'system_error': 'fa-times-circle'
            };
            return icons[type] || 'fa-info-circle';
        }

        function getNotificationColor(type) {
            const colors = {
                'sensor_offline': 'text-error',
                'sensor_online': 'text-success',
                'high_traffic': 'text-warning',
                'low_traffic': 'text-info',
                'system_update': 'text-success',
                'system_error': 'text-error'
            };
            return colors[type] || 'text-info';
        }

        function formatTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'Только что';
            if (minutes < 60) return `${minutes} мин назад`;
            if (hours < 24) return `${hours} ч назад`;
            if (days < 7) return `${days} дн назад`;
            return time.toLocaleDateString();
        }

        function markNotificationAsRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
        }

        // Обработка кнопки "Прочитать все"
        document.getElementById('mark-all-read').addEventListener('click', function() {
            fetch('/api/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(() => {
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                });
                updateNotificationBadge(0);
            });
        });

        // Загрузка уведомлений при загрузке страницы
        loadNotifications();
        
        // Функция выхода из системы
        function logout() {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                // Clear all local data
                localStorage.clear();
                sessionStorage.clear();
                
                fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(() => {
                    window.location.href = '/login';
                })
                .catch(error => {
                    console.error('Ошибка при выходе:', error);
                    window.location.href = '/login';
                });
            }
        }

        // Инициализация Яндекс карты
        let yandexMap = null;
        
        function initYandexMap() {
            if (typeof ymaps !== 'undefined') {
                ymaps.ready(function () {
                    if (!yandexMap) {
                        yandexMap = new ymaps.Map('yandex-map', {
                            center: [53.9, 27.5667], // Минск
                            zoom: 10,
                            controls: ['zoomControl', 'searchControl', 'typeSelector']
                        });

                        // Добавляем метки магазинов
                        const stores = [
                            { name: 'Магазин №1 Центр', coords: [53.9045, 27.5615], visitors: 245 },
                            { name: 'Магазин №2 Восток', coords: [53.9120, 27.5920], visitors: 189 },
                            { name: 'Магазин №3 Запад', coords: [53.8976, 27.5234], visitors: 156 },
                            { name: 'Магазин №4 Север', coords: [53.9234, 27.5545], visitors: 198 }
                        ];

                        stores.forEach(store => {
                            const placemark = new ymaps.Placemark(store.coords, {
                                balloonContent: `
                                    <div style="padding: 10px;">
                                        <h4>${store.name}</h4>
                                        <p>Посетителей сегодня: <strong>${store.visitors}</strong></p>
                                        <p>Статус: <span style="color: green;">Активен</span></p>
                                    </div>
                                `
                            }, {
                                preset: 'islands#greenDotIcon',
                                iconColor: '#2E8B57'
                            });
                            
                            yandexMap.geoObjects.add(placemark);
                        });
                    }
                });
            }
        }

        // Инициализация карты при переключении на вкладку карты
        document.getElementById('sensors-map-btn').addEventListener('click', function() {
            setTimeout(initYandexMap, 100);
        });

        // Обработка фильтров отключений датчиков
        function setupDowntimeFilters() {
            const downtimeFilter = document.getElementById('downtime-filter');
            const downtimePeriod = document.getElementById('downtime-period');
            
            if (downtimeFilter) {
                downtimeFilter.addEventListener('change', function() {
                    loadDowntimeData();
                });
            }
            
            if (downtimePeriod) {
                downtimePeriod.addEventListener('change', function() {
                    loadDowntimeData();
                });
            }
        }

        // Функция загрузки данных об отключениях
        function loadDowntimeData() {
            const filter = document.getElementById('downtime-filter').value;
            const period = document.getElementById('downtime-period').value;
            
            fetch(`/api/sensor-downtimes?filter=${filter}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    updateDowntimeDisplay(data.downtimes);
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных об отключениях:', error);
                });
        }

        // Обновление отображения отключений
        function updateDowntimeDisplay(downtimes) {
            const downtimeList = document.getElementById('downtime-list');
            
            if (downtimes.length === 0) {
                downtimeList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: var(--success-color);"></i>
                        <p>Отключений не зафиксировано</p>
                    </div>
                `;
                return;
            }

            downtimeList.innerHTML = downtimes.map(downtime => `
                <div class="downtime-item ${downtime.status}">
                    <div class="downtime-icon">
                        <i class="fas ${downtime.status === 'offline' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                    </div>
                    <div class="downtime-content-info">
                        <div class="downtime-sensor-name">${downtime.sensor_name}</div>
                        <div class="downtime-location">${downtime.store_name} - ${downtime.store_address}</div>
                        <div class="downtime-duration">
                            ${downtime.status === 'offline' ? 
                                'Отключен с ' + new Date(downtime.disconnected_at).toLocaleString() : 
                                `Отключение: ${downtime.duration_minutes} мин`
                            }
                        </div>
                    </div>
                    <div class="downtime-time">
                        <span class="${downtime.status === 'offline' ? 'offline-status' : ''}">${downtime.status === 'offline' ? 'ОФЛАЙН' : 'ВОССТАНОВЛЕН'}</span>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
